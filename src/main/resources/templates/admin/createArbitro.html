<!DOCTYPE html>
<html th:lang="${#locale}" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${modoEdicion != null} ? #{page.admin.arbitros.edit} : #{page.admin.arbitros.create}">Crear Árbitro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

</head>
<body>
    
    <div class="container my-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header" th:text="${modoEdicion != null} ? #{page.admin.arbitros.edit} : #{page.admin.arbitros.create}">Crear Nuevo Árbitro</div>
                    <div class="card-body">
                        <!-- Mensaje de error general -->
                        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <span th:text="${errorMessage}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                        
                        <form th:action="@{${modoEdicion != null ? '/admin/arbitros/update/' + arbitro.id : '/admin/arbitros/save'}}" 
                              method="post" th:object="${arbitro}" enctype="multipart/form-data">
                            
                            <!-- ID oculto para edición -->
                            <input type="hidden" th:field="*{id}" th:if="${modoEdicion != null}">
                            
                            <!-- Campos ocultos para el usuario -->
                            <input type="hidden" th:field="*{usuario.username}" id="hiddenUsername">
                            <input type="hidden" th:field="*{usuario.password}" id="hiddenPassword">
                            <input type="hidden" th:field="*{usuario.email}" id="hiddenEmail">
                            <input type="hidden" th:field="*{usuario.role}" value="ROLE_ARBITRO">
                            <input type="hidden" th:field="*{usuario.activo}" value="true">
                            
                            <!-- Errores de validación específicos -->
                            <div th:if="${#fields.hasErrors('*')}" class="alert alert-warning alert-dismissible fade show" role="alert">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                <strong th:text="#{msg.error.form.validation}">Por favor corrige los siguientes errores:</strong>
                                <ul class="mb-0 mt-2">
                                    <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
                                </ul>
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                            
                            <div class="mb-3">
                                <label for="nombre" class="form-label" th:text="#{label.nombre}">Nombre</label><span class="text-danger">*</span>
                                <input type="text" id="nombre" class="form-control" th:field="*{nombre}" 
                                       th:classappend="${#fields.hasErrors('nombre')} ? 'is-invalid' : ''" 
                                       required maxlength="100" th:placeholder="#{placeholder.nombre.completo}">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}">
                                    Error en nombre
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="username" class="form-label" th:text="#{label.username}">Nombre de Usuario</label><span class="text-danger">*</span>
                                <input type="text" id="username" class="form-control" th:field="*{username}" 
                                       th:classappend="${#fields.hasErrors('username')} ? 'is-invalid' : ''"
                                       required maxlength="100" th:placeholder="#{placeholder.username}"
                                       onchange="updateHiddenUsername()" onkeyup="updateHiddenUsername()">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('username')}" th:errors="*{username}">
                                    Error en nombre de usuario
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="contraseña" class="form-label" th:text="#{label.password}">Contraseña</label><span class="text-danger">*</span>
                                <input type="password" id="contraseña" class="form-control" th:field="*{contraseña}" 
                                       th:classappend="${#fields.hasErrors('contraseña')} ? 'is-invalid' : ''"
                                       required maxlength="100" th:placeholder="#{placeholder.password}"
                                       onchange="updateHiddenPassword()" onkeyup="updateHiddenPassword()">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('contraseña')}" th:errors="*{contraseña}">
                                    Error en contraseña
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="email" class="form-label" th:text="#{label.email}">Email</label><span class="text-danger">*</span>
                                <input type="email" id="email" class="form-control" th:field="*{usuario.email}"
                                       th:classappend="${#fields.hasErrors('usuario.email')} ? 'is-invalid' : ''"
                                       required maxlength="100" th:placeholder="#{placeholder.email}"
                                       onchange="updateHiddenEmail()" onkeyup="updateHiddenEmail()">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('usuario.email')}" th:errors="*{usuario.email}">
                                    Error en email
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="cedula" class="form-label" th:text="#{label.cedula}">Cédula</label><span class="text-danger">*</span>
                                <input type="text" id="cedula" class="form-control" th:field="*{cedula}" 
                                       th:classappend="${#fields.hasErrors('cedula')} ? 'is-invalid' : ''"
                                       pattern="[0-9]{8,20}" inputmode="numeric" th:placeholder="#{placeholder.cedula}" 
                                       required maxlength="20">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('cedula')}" th:errors="*{cedula}">
                                    Error en cédula
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="phone" class="form-label" th:text="#{label.telefono}">Teléfono</label><span class="text-danger">*</span>
                                <input type="text" id="phone" class="form-control" th:field="*{phone}" 
                                       th:classappend="${#fields.hasErrors('phone')} ? 'is-invalid' : ''"
                                       pattern="[0-9]{10,15}" inputmode="numeric" th:placeholder="#{placeholder.telefono}" 
                                       required maxlength="15">
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('phone')}" th:errors="*{phone}">
                                    Error en teléfono
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="photoFile" class="form-label" th:text="#{label.foto.arbitro}">Foto del Árbitro</label>
                                <input type="file" id="photoFile" name="photoFile" class="form-control" accept="image/*" onchange="previewImage(this)">
                                <small class="form-text text-muted" th:text="#{help.foto}">Selecciona una imagen (JPG, PNG, GIF). Máximo 5MB.</small>
                                <div id="imagePreview" class="mt-3" style="display: none;">
                                    <img id="previewImg" src="#" alt="Vista previa" style="max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="removeImagePreview()">
                                            <i class="fas fa-trash"></i><span th:text="#{btn.delete.image}">Eliminar imagen</span>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="speciality" class="form-label" th:text="#{label.especialidad}">Especialidad</label><span class="text-danger">*</span>
                                <select id="speciality" class="form-control" th:field="*{speciality}" 
                                        th:classappend="${#fields.hasErrors('speciality')} ? 'is-invalid' : ''" required>
                                    <option value="" th:text="#{placeholder.select}">Seleccione una especialidad</option>
                                    <option value="Mesa" th:text="#{especialidad.MESA}">Mesa</option>
                                    <option value="Campo" th:text="#{especialidad.CAMPO}">Campo</option>
                                </select>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('speciality')}" th:errors="*{speciality}">
                                    Error en especialidad
                                </div>
                                <small class="form-text text-muted" th:text="#{help.required}">Campo obligatorio</small>
                            </div>

            <!-- Escalafón (reemplaza el campo scale) -->
            <div class="mb-3">
                <label for="escalafon" class="form-label" th:text="#{label.escalafon}">Escalafón</label><span class="text-danger">*</span>
                <select id="escalafon" class="form-control" th:field="*{escalafon.id}" 
                        th:classappend="${#fields.hasErrors('escalafon')} ? 'is-invalid' : ''" required>
                    <option value="" th:text="#{placeholder.select.escalafon}">Seleccione un escalafón</option>
                    <option th:each="esc : ${escalafones}" 
                            th:value="${esc.id}" 
                            th:text="#{'escalafon.' + ${esc.nombre}}">
                        Escalafón
                    </option>
                </select>
                <div class="invalid-feedback" th:if="${#fields.hasErrors('escalafon')}" th:errors="*{escalafon}">
                    Error en escalafón
                </div>
                <small class="form-text text-muted" th:text="#{help.required}">Campo obligatorio</small>
            </div>                            <div class="d-flex justify-content-between">
                                <a th:href="@{/admin/arbitros}" class="btn btn-secondary" th:text="#{btn.cancel}">Cancelar</a>
                                <input type="submit" class="btn btn-primary" th:value="${modoEdicion != null} ? #{btn.update} : #{btn.save}">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Font Awesome para los iconos -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

    <!-- Script para sincronizar campos del usuario -->
    <script>
        // Sincronizar los campos del usuario con los campos ocultos
        function updateHiddenUsername() {
            const username = document.getElementById('username').value;
            const hiddenUsername = document.getElementById('hiddenUsername');
            if (hiddenUsername) {
                hiddenUsername.value = username;
            }
        }

        function updateHiddenPassword() {
            const password = "{noop}"+ document.getElementById('contraseña').value;
            const hiddenPassword = document.getElementById('hiddenPassword');
            if (hiddenPassword) {
                // Solo agregar {noop} si no lo tiene ya
                if (password && !password.startsWith('{noop}')) {
                    hiddenPassword.value = "{noop}" + password;
                } else {
                    hiddenPassword.value = password;
                }
            }
        }

        function updateHiddenEmail() {
            const email = document.getElementById('email').value;
            const hiddenEmail = document.getElementById('hiddenEmail');
            if (hiddenEmail) {
                hiddenEmail.value = email;
            }
        }

        // Funciones para manejar la imagen
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Validar tipo de archivo
                if (!file.type.startsWith('image/')) {
                    alert('Por favor selecciona un archivo de imagen válido.');
                    input.value = '';
                    return;
                }
                
                // Validar tamaño (5MB máximo)
                if (file.size > 5 * 1024 * 1024) {
                    alert('La imagen no puede ser mayor a 5MB.');
                    input.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.style.display = 'none';
                previewImg.src = '#';
            }
        }

        function removeImagePreview() {
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const fileInput = document.getElementById('photoFile');
            
            fileInput.value = '';
            previewImg.src = '#';
            preview.style.display = 'none';
        }

        // Sincronizar al cargar la página
        document.addEventListener('DOMContentLoaded', function() {
            // En modo edición, limpiar los campos ocultos primero
            updateHiddenUsername();
            updateHiddenEmail();
            updateHiddenPassword();
        });
    </script>
</body>
</html>